@page "/categories"
@attribute [Authorize]
@using TaskScheduler.Domain.Entities
@using System.ComponentModel.DataAnnotations
@using SysTask = System.Threading.Tasks.Task
@inject CategoryApiService CategoryService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Categories - Task Scheduler</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-folder"></i> Categories</h1>
        <button class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="bi bi-plus-circle"></i> New Category
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading categories...</span>
            </div>
        </div>
    }
    else if (!categories.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No categories found. Create your first category to organize your tasks!
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var category in categories)
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 shadow-sm category-card" style="border-left: 4px solid @category.Color;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0">
                                    <span class="badge rounded-circle me-2" style="background-color: @category.Color; width: 20px; height: 20px;"></span>
                                    @category.Name
                                </h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item" @onclick="() => OpenEditModal(category)">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item text-danger" @onclick="() => HandleDeleteCategory(category)">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="text-muted small">
                                <i class="bi bi-calendar3"></i> Created @category.CreatedAt.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Category Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditMode ? "Edit Category" : "Create New Category")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="@categoryModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label class="form-label">Category Name</label>
                            <InputText class="form-control" @bind-Value="categoryModel.Name" placeholder="e.g., Work, Personal, Shopping" />
                            <ValidationMessage For="@(() => categoryModel.Name)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="color" class="form-control form-control-color" @bind="categoryModel.Color" style="width: 80px;" />
                                <span class="text-muted small">@categoryModel.Color</span>
                            </div>
                            <ValidationMessage For="@(() => categoryModel.Color)" />
                        </div>

                        <div class="alert alert-light border">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge rounded-circle" style="background-color: @categoryModel.Color; width: 24px; height: 24px;"></span>
                                <span>@(string.IsNullOrWhiteSpace(categoryModel.Name) ? "Category Name" : categoryModel.Name)</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @(isEditMode ? "Update" : "Create")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<Category> categories = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private CategoryFormModel categoryModel = new();
    private Category? selectedCategory;

    protected override async SysTask OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async SysTask LoadCategories()
    {
        isLoading = true;
        categories = await CategoryService.GetAllCategoriesAsync();
        isLoading = false;
    }

    private void OpenCreateModal()
    {
        isEditMode = false;
        selectedCategory = null;
        categoryModel = new CategoryFormModel
        {
            Name = "",
            Color = "#6366f1"
        };
        showModal = true;
    }

    private void OpenEditModal(Category category)
    {
        isEditMode = true;
        selectedCategory = category;
        categoryModel = new CategoryFormModel
        {
            Name = category.Name,
            Color = category.Color
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        categoryModel = new();
        selectedCategory = null;
    }

    private async SysTask HandleSubmit()
    {
        isSaving = true;

        if (isEditMode && selectedCategory != null)
        {
            var updateDto = new UpdateCategoryDto
            {
                Name = categoryModel.Name,
                Color = categoryModel.Color
            };

            var updated = await CategoryService.UpdateCategoryAsync(selectedCategory.Id, updateDto);
            if (updated != null)
            {
                await LoadCategories();
                CloseModal();
            }
        }
        else
        {
            var createDto = new CreateCategoryDto
            {
                Name = categoryModel.Name,
                Color = categoryModel.Color
            };

            var created = await CategoryService.CreateCategoryAsync(createDto);
            if (created != null)
            {
                await LoadCategories();
                CloseModal();
            }
        }

        isSaving = false;
    }

    private async SysTask HandleDeleteCategory(Category category)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{category.Name}'?"))
            return;

        var success = await CategoryService.DeleteCategoryAsync(category.Id);
        if (success)
        {
            await LoadCategories();
        }
    }

    private class CategoryFormModel
    {
        [Required(ErrorMessage = "Category name is required")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "Category name must be between 2 and 50 characters")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Color is required")]
        [RegularExpression(@"^#([A-Fa-f0-9]{6})$", ErrorMessage = "Please enter a valid hex color")]
        public string Color { get; set; } = "#6366f1";
    }
}
