@page "/tasks"
@attribute [Authorize]
@inject TaskApiService TaskService
@inject CategoryApiService CategoryService
@inject NavigationManager Navigation

<PageTitle>My Tasks - Task Scheduler</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-list-task"></i> My Tasks</h1>
        <button class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="bi bi-plus-circle"></i> New Task
        </button>
    </div>

    <TaskFilters Categories="@categories" OnStatusFilterChanged="@HandleStatusFilter"
        OnPriorityFilterChanged="@HandlePriorityFilter" OnCategoryFilterChanged="@HandleCategoryFilter"
        OnSearchFilterChanged="@HandleSearchFilter" OnOverdueFilterChanged="@HandleOverdueFilter"
        ShowOverdue="@showOverdue" />

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading tasks...</span>
            </div>
        </div>
    }
    else if (!filteredTasks.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No tasks found. Create your first task to get started!
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var task in filteredTasks)
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <TaskCard Task="@task" OnTaskClick="@(EventCallback.Factory.Create<TaskDto>(this, HandleTaskClick))"
                        OnEditTask="@(EventCallback.Factory.Create<TaskDto>(this, HandleEditTask))"
                        OnDeleteTask="@(EventCallback.Factory.Create<TaskDto>(this, HandleDeleteTask))" />
                </div>
            }
        </div>
    }
</div>

<TaskModal IsVisible="@showModal" IsEditMode="@isEditMode" TaskToEdit="@selectedTask" Categories="@categories"
    OnCreate="@HandleCreateTask" OnUpdate="@HandleUpdateTask" OnClose="@CloseModal" />

@code {
    private List<TaskDto> tasks = new();
    private List<TaskDto> filteredTasks = new();
    private List<Client.Models.CategoryDto> categories = new();
    private TaskDto? selectedTask;
    private bool isLoading = true;
    private bool showModal;
    private bool isEditMode;
    private bool showOverdue;

    // Filters
    private string? statusFilter;
    private string? priorityFilter;
    private int? categoryFilter;
    private string? searchFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
        await LoadCategories();
    }

    private async Task LoadTasks()
    {
        try
        {
            isLoading = true;
            tasks = await TaskService.GetAllTasksAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCategories()
    {
        try
        {
            var apiCategories = await CategoryService.GetAllCategoriesAsync();
            categories = apiCategories.Select(c => new Client.Models.CategoryDto
            {
                Id = c.Id,
                Name = c.Name
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
            // Fallback to empty list
            categories = new List<Client.Models.CategoryDto>();
        }
    }

    private void ApplyFilters()
    {
        var filtered = tasks.AsEnumerable();

        if (!string.IsNullOrEmpty(statusFilter))
        {
            filtered = filtered.Where(t => t.Status.ToString() == statusFilter);
        }

        if (!string.IsNullOrEmpty(priorityFilter))
        {
            filtered = filtered.Where(t => t.Priority.ToString() == priorityFilter);
        }

        if (categoryFilter.HasValue)
        {
            filtered = filtered.Where(t => t.CategoryId == categoryFilter.Value);
        }

        if (!string.IsNullOrEmpty(searchFilter))
        {
            filtered = filtered.Where(t =>
            t.Title.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ||
            (t.Description != null && t.Description.Contains(searchFilter, StringComparison.OrdinalIgnoreCase))
            );
        }

        if (showOverdue)
        {
            filtered = filtered.Where(t => t.IsOverdue);
        }

        filteredTasks = filtered.ToList();
    }

    private void HandleStatusFilter(string? status)
    {
        statusFilter = status;
        ApplyFilters();
    }

    private void HandlePriorityFilter(string? priority)
    {
        priorityFilter = priority;
        ApplyFilters();
    }

    private void HandleCategoryFilter(int? categoryId)
    {
        categoryFilter = categoryId;
        ApplyFilters();
    }

    private void HandleSearchFilter(string? search)
    {
        searchFilter = search;
        ApplyFilters();
    }

    private void HandleOverdueFilter(bool overdue)
    {
        showOverdue = overdue;
        ApplyFilters();
    }

    private void OpenCreateModal()
    {
        isEditMode = false;
        selectedTask = null;
        showModal = true;
    }

    private void HandleTaskClick(TaskDto task)
    {
        // Can expand to show task details
        Console.WriteLine($"Task clicked: {task.Title}");
    }

    private void HandleEditTask(TaskDto task)
    {
        isEditMode = true;
        selectedTask = task;
        showModal = true;
    }

    private async Task HandleDeleteTask(TaskDto task)
    {
        if (confirm($"Are you sure you want to delete '{task.Title}'?"))
        {
            try
            {
                await TaskService.DeleteTaskAsync(task.Id);
                await LoadTasks();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting task: {ex.Message}");
            }
        }
    }

    private async Task HandleCreateTask(CreateTaskDto createDto)
    {
        try
        {
            await TaskService.CreateTaskAsync(createDto);
            await LoadTasks();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating task: {ex.Message}");
        }
    }

    private async Task HandleUpdateTask((int Id, UpdateTaskDto Task) update)
    {
        try
        {
            await TaskService.UpdateTaskAsync(update.Id, update.Task);
            await LoadTasks();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating task: {ex.Message}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        selectedTask = null;
    }

    private bool confirm(string message)
    {
        // TODO: Replace with proper confirmation dialog
        return true;
    }
}