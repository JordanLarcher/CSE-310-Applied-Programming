@page "/tasks"
@using TaskScheduler.Shared
@using System.Net.Http.Json
@inject HttpClient Http

<PageTitle>Task Scheduler</PageTitle>

<h1>Task Scheduler</h1>

<!-- ************************** -->
<!-- SECTION 1: CREATE TASK FORM -->
<!-- ************************** -->
<div class="card bg-light shadow-sm mb-4">
    <div class="card-body">
        <!-- EditForm is Blazor's way of handling forms.
             We bind it to our 'newTask' variable. -->
        <EditForm Model="@newTask" OnValidSubmit="@CreateTask">
            <!-- This tells the form to use data validation (e.g., [Required]) -->
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label for="title" class="form-label">Task Title</label>
                <!-- @bind-Value links this input to the 'Title' property
                     of our 'newTask' variable. -->
                <InputText id="title" class="form-control" @bind-Value="newTask.Title" />
                <!-- This displays validation errors for the 'Title' property -->
                <ValidationMessage For="@(() => newTask.Title)" />
            </div>

            <div class="mb-3">
                <label for="due-date" class="form-label">Due Date</label>
                <InputDate id="due-date" class="form-control" @bind-Value="newTask.DueDate" />
            </div>

            <div class="mb-3">
                <label for="reminder-time" class="form-label">Reminder Time (Optional)</label>
                <InputDate id="reminder-time" class="form-control" @bind-Value="newTask.ReminderTime" />
            </div>

            <button type="submit" class="btn btn-primary">Add Task</button>
        </EditForm>
    </div>
</div>


<!-- ************************** -->
<!-- SECTION 2: TASK LIST       -->
<!-- ************************** -->

@if (tasks == null)
{
    <p><em>Loading tasks...</em></p>
}
else
{
    <ul class="list-group shadow-sm">
        <!-- REQUIREMENT: Loops -->
        <!-- We loop over the 'tasks' list and render a row for each one. -->
        @foreach (var task in tasks)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <!-- REQUIREMENT: Conditionals (Ternary Operator) -->
                    <!-- This expression changes the style based on a condition. -->
                    <input type="checkbox" class="form-check-input me-2"
                           checked="@task.IsComplete" 
                           @onchange="@(async (ChangeEventArgs e) => { task.IsComplete = (bool)e.Value!; await UpdateTask(task); })" />
                    
                    <span style="@(task.IsComplete ? "text-decoration: line-through; opacity: 0.6;" : "")">
                        <strong>@task.Title</strong>
                        <br />
                        <small>Due: @task.DueDate.ToShortDateString()</small>
                        @if (task.ReminderTime.HasValue)
                        {
                            <small class="ms-2 fst-italic text-muted">
                                (Reminder: @task.ReminderTime.Value.ToShortTimeString())
                            </small>
                        }
                    </span>
                </div>
                
                <button class="btn btn-danger btn-sm" @onclick="@(() => DeleteTask(task.Id))">
                    Delete
                </button>
            </li>
        }
    </ul>
}

<!-- ************************** -->
<!-- SECTION 3: C# CODE BLOCK   -->
<!-- ************************** -->
@code {
    // REQUIREMENT: Variables
    // These are variables that hold the state for our page.
    private List<TaskItem>? tasks;
    private TaskItem newTask = new TaskItem();

    // REQUIREMENT: Functions (Methods)
    // This function is a built-in Blazor event. It runs
    // automatically when the page is first loaded.
    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
    }

    // Function to get all tasks from our API
    private async Task LoadTasks()
    {
        try
        {
            // Http.GetFromJsonAsync sends a GET request to our API
            // (e.g., GET /api/Tasks) and automatically converts
            // the JSON response into a List<TaskItem>.
            tasks = await Http.GetFromJsonAsync<List<TaskItem>>("api/Tasks");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
        }
    }

    // Function to create a new task
    private async Task CreateTask()
    {
        try
        {
            // Http.PostAsJsonAsync sends a POST request to our API
            // (e.g., POST /api/Tasks) with the 'newTask' object
            // converted to JSON in the body.
            var response = await Http.PostAsJsonAsync("api/Tasks", newTask);

            if (response.IsSuccessStatusCode)
            {
                newTask = new TaskItem(); // Reset the form
                await LoadTasks();        // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating task: {ex.Message}");
        }
    }

    // Function to update a task (e.g., mark as complete)
    private async Task UpdateTask(TaskItem task)
    {
        try
        {
            // Http.PutAsJsonAsync sends a PUT request
            // (e.g., PUT /api/Tasks/5) with the updated task object.
            await Http.PutAsJsonAsync($"api/Tasks/{task.Id}", task);
            
            // We don't need to reload the whole list, but we
            // will just to ensure data is consistent.
            await LoadTasks();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating task: {ex.Message}");
        }
    }

    // Function to delete a task
    private async Task DeleteTask(int id)
    {
        try
        {
            // Http.DeleteAsync sends a DELETE request
            // (e.g., DELETE /api/Tasks/5)
            await Http.DeleteAsync($"api/Tasks/{id}");
            
            await LoadTasks(); // Refresh the list
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting task: {ex.Message}");
        }
    }
}
